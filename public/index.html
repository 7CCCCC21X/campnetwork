<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Camp Network 批量女巫检测</title>
<style>
:root{--bg:#f9fafb;--card:#fff;--text:#1f2937;--sub:#6b7280;--primary:#2563eb;--ok:#16a34a;--err:#dc2626;--border:#e5e7eb}
@media(prefers-color-scheme:dark){:root{--bg:#1e293b;--card:#334155;--text:#f3f4f6;--sub:#9ca3af;--border:#475569}}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,"Segoe UI","PingFang SC",sans-serif;background:var(--bg);color:var(--text);padding:20px;line-height:1.5}
h1{font-size:1.35rem;text-align:center;margin-bottom:14px;color:var(--primary)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
textarea{flex:1 1 100%;height:180px;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);resize:vertical}
button{padding:8px 14px;font-size:.95rem;border:none;border-radius:6px;cursor:pointer;color:#fff;white-space:nowrap}
#checkBtn{background:var(--primary)}
#copyBad{background:var(--err);display:none}
#copyGood{background:var(--ok);display:none}
.summary{margin:8px 0;font-size:.9rem;color:var(--sub)}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px;min-width:600px}
th,td{border:1px solid var(--border);padding:6px 8px;text-align:center}
th{background:var(--card);position:sticky;top:0}
.bad{color:var(--err);font-weight:700}
.good{color:var(--ok);font-weight:700}
.loading{animation:spin 1s linear infinite;border:2px solid var(--primary);border-top-color:transparent;border-radius:50%;width:14px;height:14px;margin:auto}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<h1>Camp Network 女巫检测</h1>

<div class="controls">
  <textarea id="addrInput" placeholder="一行一个地址"></textarea>
  <button id="checkBtn">开始查询</button>
  <button id="copyBad">复制全部女巫</button>
  <button id="copyGood">复制全部正常</button>
</div>

<div class="summary" id="stats">请输入地址后点击“开始查询”</div>

<div style="overflow-x:auto">
<table id="resultTbl">
  <thead><tr><th>#</th><th>地址</th><th>状态</th></tr></thead>
  <tbody></tbody>
</table>
</div>

<script>
const API_BASE = '/api/query?address=';   // 如需直连官方 API, 改成字符串前缀
const addrInput = document.getElementById('addrInput');
const stats     = document.getElementById('stats');
const tbody     = document.querySelector('#resultTbl tbody');
const copyBad   = document.getElementById('copyBad');
const copyGood  = document.getElementById('copyGood');
const checkBtn  = document.getElementById('checkBtn');

function uniq(arr){return Array.from(new Set(arr.filter(Boolean)));}

checkBtn.onclick = async ()=>{
  const addrs = uniq(addrInput.value.trim().split(/\s+/));
  if(!addrs.length) return alert('请先输入地址');
  stats.textContent = `正在查询 ${addrs.length} 个地址…`;
  tbody.innerHTML   = '';
  copyBad.style.display = copyGood.style.display = 'none';

  const bad=[], good=[];
  const BATCH = 5;
  for(let i=0;i<addrs.length;i+=BATCH){
    const chunk = addrs.slice(i,i+BATCH);
    await Promise.all(chunk.map(async (addr,idx)=>{
      const row = tbody.insertRow();
      row.insertCell().textContent = i+idx+1;
      row.insertCell().textContent = addr;
      const statusCell=row.insertCell();
      statusCell.innerHTML='<span class="loading"></span>';

      try{
        const r = await fetch(API_BASE+addr).then(r=>r.json());
        const blocked = r?.data?.[0]?.userMetadata?.[0]?.isBlocked;
        if(blocked===true){
          statusCell.textContent='女巫'; statusCell.className='bad'; bad.push(addr);
        }else if(blocked===false){
          statusCell.textContent='正常'; statusCell.className='good'; good.push(addr);
        }else{
          statusCell.textContent='未知';
        }
      }catch{
        statusCell.textContent='错误';
      }
    }));
  }

  stats.textContent = `总数 ${addrs.length} ｜ 正常 ${good.length} ｜ 女巫 ${bad.length}`;
  if(bad.length){
    copyBad.style.display='inline-block';
    copyBad.onclick=()=>navigator.clipboard.writeText(bad.join('\n'));
  }
  if(good.length){
    copyGood.style.display='inline-block';
    copyGood.onclick=()=>navigator.clipboard.writeText(good.join('\n'));
  }
};
</script>
</body>
</html>
